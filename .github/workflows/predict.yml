name: ü§ñ Predict Feeds (Auto-Agent)

on:
  schedule:
    - cron: "*/180 * * * *"  # every 3 hours
  workflow_dispatch:

jobs:
  predict:
    runs-on: ubuntu-latest

    steps:
      - name: üß± Checkout repo
        uses: actions/checkout@v3

      - name: üêç Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: üì¶ Install dependencies
        run: pip install -r requirements.txt

      - name: üîÆ Run Predictoor Agent
        id: agent_run
        run: |
          python agent_predictoor.py | tee predict_log.txt
        env:
          WALLET_PRIVATE_KEY: ${{ secrets.WALLET_PRIVATE_KEY }}
          WALLET_ADDRESS: ${{ secrets.WALLET_ADDRESS }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}

      - name: üß© Extract errors or warnings
        id: log_summary
        run: |
          echo "errors=$(grep -E '‚ùå|‚ö†Ô∏è|Error|Failed|Traceback' predict_log.txt || echo 'None')" >> $GITHUB_OUTPUT

      - name: üíæ Commit logs
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add performance_log.json || true
          git commit -m "Update performance logs" || echo "No changes"
          git push

      - name: üì≤ Send Telegram summary
        if: always()
        run: |
          MSG="ü§ñ Predictoor Agent Run Completed
          ‚Ä¢ Repo: $GITHUB_REPOSITORY
          ‚Ä¢ Status: ${{ job.status }}
          ‚Ä¢ Time: $(date -u)

          ‚öôÔ∏è Summary:
          ${{ steps.log_summary.outputs.errors }}"
          
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage \
            -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
            -d text="$MSG"
